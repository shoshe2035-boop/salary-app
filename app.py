import streamlit as st
from datetime import date

# ---------------------------------------------------------
# ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ - ุชุบููุฑ ุงูุนููุงู ูุชูููุฒ ุงููุณุฎุฉ ุงูุฌุฏูุฏุฉ
# ---------------------------------------------------------
st.set_page_config(page_title="ุงููุธุงู ุงููุญุฏุซ V3", layout="wide")

# CSS ูุชูุณูู ุงูุฌุฏุงูู ูุงูุฃููุงู (ููุชุฃูุฏ ูู ุชุบููุฑ ุงูุดูู)
st.markdown("""
<style>
    .main {direction: rtl; text-align: right;}
    h1 {color: #1f77b4;}
    .stTable {direction: rtl;}
    div[data-testid="stMetricValue"] {font-size: 24px;}
</style>
""", unsafe_allow_html=True)

st.title("๐ ุงููุธุงู ุงููุญุฏุซ: ุญุงุณุจุฉ ุงููุฑููุงุช (ูุณุฎุฉ V3)")
st.caption("ุชู ุชุญุฏูุซ ููุทู ุงูุญุณุงุจ ููุชุทุงุจู ูุน ุญุงูุฉ 'ูุตุทูู' ุจุฏูุฉ 100%")

# ---------------------------------------------------------
# ุฏูุงู ุงูุญุณุงุจ
# ---------------------------------------------------------
def get_months_diff(start, end):
    """ุญุณุงุจ ุนุฏุฏ ุงูุฃุดูุฑ ูุชุฌุงูู ุงูุฃูุงู (ููุทู DATEDIF)"""
    if not start or not end or start >= end:
        return 0
    return (end.year - start.year) * 12 + (end.month - start.month)

# ---------------------------------------------------------
# ูุงุฌูุฉ ุงูุฅุฏุฎุงู
# ---------------------------------------------------------
# ุงูุตู ุงูุฃูู: ุงูุฑูุงุชุจ
st.subheader("1๏ธโฃ ุงูุจูุงูุงุช ุงููุงููุฉ")
c1, c2, c3, c4, c5 = st.columns(5)
with c1:
    base_sal = st.number_input("ุงูุฑุงุชุจ ุงูุงุณูู ุงููุฏูู", value=250, key="base")
with c2:
    s1 = st.number_input("ุฑุงุชุจ ุงูุนูุงูุฉ 1", value=260, key="s1")
with c3:
    s2 = st.number_input("ุฑุงุชุจ ุงูุนูุงูุฉ 2", value=270, key="s2")
with c4:
    s3 = st.number_input("ุฑุงุชุจ ุงูุนูุงูุฉ 3", value=0, key="s3")
with c5:
    sp = st.number_input("ุงูุฑุงุชุจ ุจุนุฏ ุงูุชุฑููุน", value=300, key="sp")

# ุงูุตู ุงูุซุงูู: ุงูุชูุงุฑูุฎ ูุงูุดูุงุฏุฉ
st.subheader("2๏ธโฃ ุงูุชูุงุฑูุฎ ูุงูุดูุงุฏุฉ")
d_col1, d_col2, d_col3, d_col4, d_col5 = st.columns(5)
with d_col1:
    d1 = st.date_input("ุชุงุฑูุฎ ุงูุนูุงูุฉ 1", value=date(2022, 6, 1))
with d_col2:
    d2 = st.date_input("ุชุงุฑูุฎ ุงูุนูุงูุฉ 2", value=date(2023, 1, 1))
with d_col3:
    d3 = st.date_input("ุชุงุฑูุฎ ุงูุนูุงูุฉ 3", value=None)
with d_col4:
    dp = st.date_input("ุชุงุฑูุฎ ุงูุชุฑููุน", value=date(2024, 6, 1))
with d_col5:
    de = st.date_input("ููุงูุฉ ุงููุชุฑุฉ", value=date(2024, 12, 1))

degree = st.selectbox("ุงูุดูุงุฏุฉ", ["ุฏูุชูุฑุงู", "ูุงุฌุณุชูุฑ", "ุจูุงููุฑููุณ", "ุฃุฎุฑู/ุฃููุฉ"], index=3)
degree_map = {"ุฏูุชูุฑุงู": 1.0, "ูุงุฌุณุชูุฑ": 0.75, "ุจูุงููุฑููุณ": 0.50, "ุฃุฎุฑู/ุฃููุฉ": 0.15}
rate = degree_map[degree]

# ---------------------------------------------------------
# ููุทู ุงููุนุงูุฌุฉ (ุงูููุฒ ููู ุงููุฑุงุบุงุช + ุงููุฑู ุนู ุงูุฑุงุชุจ ุงููุฏูู)
# ---------------------------------------------------------

# ุชุญุฏูุฏ ููุงูุฉ ูู ูุฑุญูุฉ ุฃูุชููุงุชูููุงู
end1 = d2 if d2 else (d3 if d3 else (dp if dp else de))
end2 = d3 if d3 else (dp if dp else de)
end3 = dp if dp else de

# ุญุณุงุจ ุงูุฃุดูุฑ
m1 = get_months_diff(d1, end1)
m2 = get_months_diff(d2, end2) if d2 else 0
m3 = get_months_diff(d3, end3) if d3 else 0
mp = get_months_diff(dp, de) if dp else 0

# ุญุณุงุจ ุงููุฑููุงุช (ุงูุฑุงุชุจ ุงูุญุงูู - ุงูุฑุงุชุจ ุงููุฏูู ุงูุฃุณุงุณู)
f1_n = (s1 - base_sal) * m1 if s1 else 0
f2_n = (s2 - base_sal) * m2 if s2 else 0
f3_n = (s3 - base_sal) * m3 if s3 else 0
fp_n = (sp - base_sal) * mp if sp else 0

# ---------------------------------------------------------
# ุนุฑุถ ุงููุชุงุฆุฌ
# ---------------------------------------------------------
st.divider()
st.subheader("3๏ธโฃ ุงููุชุงุฆุฌ ุงูุชูุตูููุฉ")

# ุชุฌููุฒ ุงูุจูุงูุงุช ููุฌุฏูู
data = []
if m1 > 0: data.append(["ุงูุนูุงูุฉ ุงูุฃููู", m1, f"{f1_n:,.0f}", f"{f1_n * rate:,.1f}"])
if m2 > 0: data.append(["ุงูุนูุงูุฉ ุงูุซุงููุฉ", m2, f"{f2_n:,.0f}", f"{f2_n * rate:,.1f}"])
if m3 > 0: data.append(["ุงูุนูุงูุฉ ุงูุซุงูุซุฉ", m3, f"{f3_n:,.0f}", f"{f3_n * rate:,.1f}"])
if mp > 0: data.append(["ุงูุชุฑููุน", mp, f"{fp_n:,.0f}", f"{fp_n * rate:,.1f}"])

# ุนุฑุถ ุงูุฌุฏูู
if data:
    st.table([{"ุงููุฑุญูุฉ": r[0], "ุนุฏุฏ ุงูุฃุดูุฑ": r[1], "ุงููุฑู ุงูุงุณูู": r[2], "ุงููุฑู ุงูุนุงู (ุงููุณุชุญู)": r[3]} for r in data])
    
    # ุญุณุงุจ ุงูุฅุฌูุงูู
    total_general = (f1_n * rate) + (f2_n * rate) + (f3_n * rate) + (fp_n * rate)
    
    st.success(f"ุงููุฌููุน ุงูููู ูููุณุชุญู ุงูููุงุฆู: {total_general:,.1f}")
else:
    st.warning("ูุฑุฌู ุงูุชุฃูุฏ ูู ุฅุฏุฎุงู ุชุงุฑูุฎ ุงูุนูุงูุฉ ุงูุฃููู ูุชุงุฑูุฎ ุงูููุงูุฉ.")
