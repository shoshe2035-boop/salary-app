import streamlit as st
from datetime import date

# ---------------------------------------------------------
# ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ
# ---------------------------------------------------------
st.set_page_config(page_title="ุญุงุณุจุฉ ุงููุฑููุงุช (Excel Logic)", layout="wide")

st.markdown("""
<style>
    .main {direction: rtl; text-align: right;}
    div.stButton > button {width: 100%;}
    .stTable {direction: rtl; text-align: right;}
    input {text-align: right;}
    th, td {text-align: right !important;}
</style>
""", unsafe_allow_html=True)

st.title("๐ ูุญุงูู ุงูุฅูุณู (Excel Logic Simulator)")
st.info("ุชู ุจูุงุก ูุฐุง ุงูุชุทุจูู ุจูุงุกู ุนูู ุงููุนุงุฏูุงุช ุงูุญุฑููุฉ ููุฑูุฉ Excel (ูุฑูุฉ1 - ุงูุตู 2).")

# ---------------------------------------------------------
# ุฏูุงู ุงููุณุงุนุฏุฉ (ุงููุญุฑู ุงูููุทูู)
# ---------------------------------------------------------
def excel_datedif_m(start_date, end_date):
    """
    ุชุญุงูู ุฏุงูุฉ DATEDIF(Start, End, "M") ูู ุงูุฅูุณู
    ุชุญุณุจ ุงููุฑู ุจุงูุดููุฑ ุงููุงููุฉ ูุชุชุฌุงูู ุงูุฃูุงู.
    """
    if not start_date or not end_date:
        return 0
    if start_date >= end_date:
        return 0
    return (end_date.year - start_date.year) * 12 + (end_date.month - start_date.month)

# ---------------------------------------------------------
# 1๏ธโฃ ูุณู ุงูุฅุฏุฎุงูุงุช (Input Columns)
# ุงููุณุชุฎุฏู ููุฏุฎู ุงูุจูุงูุงุช ููุง ููุท
# ---------------------------------------------------------
st.header("1๏ธโฃ ุฅุฏุฎุงู ุงูุจูุงูุงุช (Input Columns)")

col_main1, col_main2, col_main3 = st.columns(3)

with col_main1:
    # ุงูุนููุฏ B: ุงูุงุณู
    name = st.text_input("B: ุงุณู ุงูููุธู", "ููุธู ุงูุชุฑุงุถู")
    # ุงูุนููุฏ U: ุงูุดูุงุฏุฉ
    degree = st.selectbox("U: ุงูุดูุงุฏุฉ", ["ุฏูุชูุฑุงู", "ูุงุฌุณุชูุฑ", "ุงุนุฏุงุฏูุฉ", "ูุชูุณุทุฉ", "ุงุจุชุฏุงุฆูุฉ", "ุฃููุฉ", "ุจูุงููุฑููุณ", "ุฃุฎุฑู"], index=6)

with col_main2:
    # ุงูุนููุฏ F: ูููุฉ ุงูุนูุงูุฉ (ููู ุฌุฏุงู ูููุนุงุฏูุงุช P, Q, R, S)
    # ููุงุญุธุฉ: ุญุณุจ ูุนุงุฏูุชู P2 = L2 * F2ุ ุฅุฐู F ูู ุงููุจูุบ ูููุณ ุงูุฑุงุชุจ ุงููุงูู
    f_val = st.number_input("F: ูููุฉ ุงูุนูุงูุฉ (Increment Value)", value=10, help="ุงููููุฉ ุงูุชู ุชุถุฑุจ ูู ุนุฏุฏ ุงูุฃุดูุฑ ูุญุณุงุจ ุงููุฑู")
    
    # ุงูุนููุฏ E: ุงูุฑุงุชุจ ุจุนุฏ ุงูุชุฑููุน (ููู ูููุนุงุฏูุฉ S)
    e_val = st.number_input("E: ุงูุฑุงุชุจ ุจุนุฏ ุงูุชุฑููุน", value=300)
    
    # ุงูุนููุฏ D: ุงูุฑุงุชุจ ูุจู ุงูุนูุงูุฉ (ููุนุฑุถ ููุทุ ูู ูุฏุฎู ูู ูุนุงุฏูุงุช ุงููุฑู ุงููุฐููุฑุฉ)
    d_val = st.number_input("D: ุงูุฑุงุชุจ ูุจู ุงูุนูุงูุฉ", value=250)

with col_main3:
    # ุงูุชูุงุฑูุฎ (G, H, I, J, K)
    k_date = st.date_input("K: ุชุงุฑูุฎ ููุงูุฉ ุงูุงุญุชุณุงุจ", value=date.today())

st.subheader("๐ ุชูุงุฑูุฎ ุงูุงุณุชุญูุงู")
d_col1, d_col2, d_col3, d_col4 = st.columns(4)
with d_col1:
    g_date = st.date_input("G: ุชุงุฑูุฎ ุงูุนูุงูุฉ ุงูุฃููู", value=None)
with d_col2:
    h_date = st.date_input("H: ุชุงุฑูุฎ ุงูุนูุงูุฉ ุงูุซุงููุฉ", value=None)
with d_col3:
    i_date = st.date_input("I: ุชุงุฑูุฎ ุงูุนูุงูุฉ ุงูุซุงูุซุฉ", value=None)
with d_col4:
    j_date = st.date_input("J: ุชุงุฑูุฎ ุงูุชุฑููุน", value=None)

# ---------------------------------------------------------
# 2๏ธโฃ ุงูุฃุนูุฏุฉ ุงููุญุณูุจุฉ (Calculated Columns)
# ุชุญููู ูุนุงุฏูุงุช ุงูุฅูุณู ุฅูู Python
# ---------------------------------------------------------

# === ุญุณุงุจ ุงูุฃุดูุฑ (L, M, N, O) ===

# ุงูุนููุฏ L: ุนุฏุฏ ุงุดูุฑ ุงูุนูุงูุฉ ุงูุฃููู
# ุงููุนุงุฏูุฉ: =IF(G2="",0,DATEDIF(G2,IF(H2<>"",H2,IF(I2<>"",I2,IF(J2<>"",J2,K2))),"M"))
if not g_date:
    l_months = 0
else:
    # ุชุญุฏูุฏ ุชุงุฑูุฎ ุงูููุงูุฉ ุจูุงุกู ุนูู ุงูุชุฏุงุฎู (Nested IF)
    if h_date: end_l = h_date
    elif i_date: end_l = i_date
    elif j_date: end_l = j_date
    else: end_l = k_date
    l_months = excel_datedif_m(g_date, end_l)

# ุงูุนููุฏ M: ุนุฏุฏ ุงุดูุฑ ุงูุนูุงูุฉ ุงูุซุงููุฉ
# ุงููุนุงุฏูุฉ: =IF(H2="",0,DATEDIF(H2,IF(I2<>"",I2,IF(J2<>"",J2,K2)),"M"))
if not h_date:
    m_months = 0
else:
    if i_date: end_m = i_date
    elif j_date: end_m = j_date
    else: end_m = k_date
    m_months = excel_datedif_m(h_date, end_m)

# ุงูุนููุฏ N: ุนุฏุฏ ุงุดูุฑ ุงูุนูุงูุฉ ุงูุซุงูุซุฉ
# ุงููุนุงุฏูุฉ: =IF(I2="",0,DATEDIF(I2,IF(J2<>"",J2,K2),"M"))
if not i_date:
    n_months = 0
else:
    if j_date: end_n = j_date
    else: end_n = k_date
    n_months = excel_datedif_m(i_date, end_n)

# ุงูุนููุฏ O: ุนุฏุฏ ุงูุฃุดูุฑ ุจุนุฏ ุงูุชุฑููุน
# ุงููุนุงุฏูุฉ: =IF(J2="",0,DATEDIF(J2,K2,"M"))
if not j_date:
    o_months = 0
else:
    o_months = excel_datedif_m(j_date, k_date)

# === ุญุณุงุจ ุงููุฑููุงุช ุงูุงุณููุฉ (P, Q, R, S) ===

# ุงูุนููุฏ P: ุงููุฑู ุงูุงุณูู ููุนูุงูุฉ ุงูุฃููู
# ุงููุนุงุฏูุฉ: =L2*F2
p_diff = l_months * f_val

# ุงูุนููุฏ Q: ุงููุฑู ุงูุงุณูู ููุนูุงูุฉ ุงูุซุงููุฉ
# ุงููุนุงุฏูุฉ: =M2*F2
q_diff = m_months * f_val

# ุงูุนููุฏ R: ุงููุฑู ุงูุงุณูู ููุนูุงูุฉ ุงูุซุงูุซุฉ
# ุงููุนุงุฏูุฉ: =N2*F2
r_diff = n_months * f_val

# ุงูุนููุฏ S: ุงููุฑู ุงูุงุณูู ุจุนุฏ ุงูุชุฑููุน
# ุงููุนุงุฏูุฉ: =O2*(E2-F2)
# ููุงุญุธุฉ: ููุง ูุชู ุทุฑุญ ูููุฉ ุงูุนูุงูุฉ (F) ูู ุฑุงุชุจ ุงูุชุฑููุน (E) ุซู ุงูุถุฑุจ ูู ุงูุฃุดูุฑ
s_diff = o_months * (e_val - f_val)

# === ุงููุฌุงููุน ูุงููุณุจ (T, V) ===

# ุงูุนููุฏ T: ุฅุฌูุงูู ุงููุฑู ุงูุงุณูู
# ุงููุนุงุฏูุฉ: =SUM(P2:S2)
t_total = p_diff + q_diff + r_diff + s_diff

# ุงูุนููุฏ V: ูุณุจุฉ ุงูุดูุงุฏุฉ
# ุงููุนุงุฏูุฉ: IFs Logic
if degree == "ุฏูุชูุฑุงู":
    v_ratio = 1.00 # 100%
    v_text = "100%"
elif degree == "ูุงุฌุณุชูุฑ":
    v_ratio = 0.75 # 75%
    v_text = "75%"
elif degree in ["ุงุนุฏุงุฏูุฉ", "ูุชูุณุทุฉ", "ุงุจุชุฏุงุฆูุฉ", "ุฃููุฉ"]:
    v_ratio = 0.15 # 15%
    v_text = "15%"
else:
    v_ratio = 0.0 # ุบูุฑ ุฐูู ุฃู ุจูุงููุฑููุณ (ูู ุชุฐูุฑ ูู ูุนุงุฏูุชู ุงูุฃุฎูุฑุฉ ุจูุถูุญ ูููู ุณุฃูุชุฑุถ 50% ุฃู 0 ุญุณุจ ุงูุญุงุฌุฉ)
    # ุชูุจูู: ูู ูุนุงุฏูุชู ุงูุฃุฎูุฑุฉ ูู ุชุฐูุฑ "ุจูุงููุฑููุณ"ุ ุณุฃุถูููุง ูู 50% ุงุญุชูุงุทุงู
    if degree == "ุจูุงููุฑููุณ":
        v_ratio = 0.50
        v_text = "50%"
    else:
        v_text = "ุบูุฑ ูุนุฑูู"

# ุญุณุงุจ ุงููุจูุบ ุงููุณุชุญู (ุฅุถุงูุฉ ููู ููููู ุงูุชุทุจูู ูููุฏุงูุ ููู ุญุงุตู ุถุฑุจ ุงูุฅุฌูุงูู ูู ุงููุณุจุฉ)
final_due = t_total * v_ratio

# ---------------------------------------------------------
# 3๏ธโฃ ุนุฑุถ ุงููุชุงุฆุฌ (Output)
# ุนุฑุถ ุงูุจูุงูุงุช ููุง ุณุชุธูุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู ููู ุงูุฅูุณู ุงููุงุชุฌ
# ---------------------------------------------------------
st.divider()
st.header("2๏ธโฃ ุงููุชุงุฆุฌ ุงููุญุณูุจุฉ (Calculated Columns)")

# ุนุฑุถ ุงููุชุงุฆุฌ ูู ุฌุฏูู ุชูุงุนูู
results_data = [
    {"ุงูุนููุฏ": "L (ุฃุดูุฑ ุนูุงูุฉ 1)", "ุงููููุฉ": l_months, "ุงููุนุงุฏูุฉ": "DATEDIF(G, Next, M)"},
    {"ุงูุนููุฏ": "M (ุฃุดูุฑ ุนูุงูุฉ 2)", "ุงููููุฉ": m_months, "ุงููุนุงุฏูุฉ": "DATEDIF(H, Next, M)"},
    {"ุงูุนููุฏ": "N (ุฃุดูุฑ ุนูุงูุฉ 3)", "ุงููููุฉ": n_months, "ุงููุนุงุฏูุฉ": "DATEDIF(I, Next, M)"},
    {"ุงูุนููุฏ": "O (ุฃุดูุฑ ุชุฑููุน)", "ุงููููุฉ": o_months, "ุงููุนุงุฏูุฉ": "DATEDIF(J, K, M)"},
    {"---": "---", "---": "---", "---": "---"},
    {"ุงูุนููุฏ": "P (ูุฑู ุนูุงูุฉ 1)", "ุงููููุฉ": f"{p_diff:,.0f}", "ุงููุนุงุฏูุฉ": "L * F"},
    {"ุงูุนููุฏ": "Q (ูุฑู ุนูุงูุฉ 2)", "ุงููููุฉ": f"{q_diff:,.0f}", "ุงููุนุงุฏูุฉ": "M * F"},
    {"ุงูุนููุฏ": "R (ูุฑู ุนูุงูุฉ 3)", "ุงููููุฉ": f"{r_diff:,.0f}", "ุงููุนุงุฏูุฉ": "N * F"},
    {"ุงูุนููุฏ": "S (ูุฑู ุชุฑููุน)", "ุงููููุฉ": f"{s_diff:,.0f}", "ุงููุนุงุฏูุฉ": "O * (E - F)"},
]

st.table(results_data)

st.markdown("---")
st.subheader("๐ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ")

col_final1, col_final2, col_final3 = st.columns(3)

with col_final1:
    st.info("T: ุฅุฌูุงูู ุงููุฑู ุงูุงุณูู")
    st.metric("Total Nominal", f"{t_total:,.0f}")

with col_final2:
    st.warning(f"V: ูุณุจุฉ ุงูุดูุงุฏุฉ ({degree})")
    st.metric("Percentage", v_text)

with col_final3:
    st.success("ุงููุจูุบ ุงููุณุชุญู ุงูููุงุฆู (T * V)")
    st.metric("Final Amount", f"{final_due:,.1f}")
